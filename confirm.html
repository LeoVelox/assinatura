<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Confirmando Email - SarmTech</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }
      .container {
        background: white;
        padding: 40px;
        border-radius: 15px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        text-align: center;
        max-width: 500px;
        width: 100%;
      }
      .success-icon {
        font-size: 60px;
        color: #28a745;
        margin-bottom: 20px;
        animation: bounce 2s infinite;
      }
      @keyframes bounce {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        }
      }
      h1 {
        color: #333;
        margin-bottom: 15px;
      }
      p {
        color: #666;
        margin-bottom: 20px;
        line-height: 1.6;
      }
      .btn {
        display: inline-block;
        background: #007bff;
        color: white;
        padding: 15px 30px;
        border-radius: 8px;
        text-decoration: none;
        font-weight: bold;
        margin: 10px;
        transition: transform 0.3s;
      }
      .btn:hover {
        transform: translateY(-2px);
        background: #0056b3;
      }
      .loading {
        color: #007bff;
        font-size: 18px;
        margin: 20px 0;
      }
      .error {
        color: #dc3545;
        background: #f8d7da;
        padding: 15px;
        border-radius: 8px;
        margin: 20px 0;
      }
      .success {
        color: #28a745;
        background: #d4edda;
        padding: 15px;
        border-radius: 8px;
        margin: 20px 0;
      }
      .debug-info {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-top: 20px;
        font-family: monospace;
        font-size: 12px;
        text-align: left;
        max-height: 200px;
        overflow-y: auto;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div id="loading">
        <div class="loading">
          <div style="font-size: 40px">‚è≥</div>
          <p>Processando confirma√ß√£o do email...</p>
          <p><small>Por favor, aguarde alguns segundos.</small></p>
        </div>
      </div>

      <div id="success" style="display: none">
        <div class="success-icon">‚úÖ</div>
        <h1>Email Confirmado com Sucesso!</h1>
        <p>
          Sua conta foi ativada e seu <strong>trial de 30 dias</strong> est√°
          pronto para uso.
        </p>

        <div style="margin: 30px 0">
          <a href="https://sarmtech.netlify.app/login.html" class="btn">
            üöÄ Ir para o Sistema
          </a>
          <a
            href="https://sarm-tech.netlify.app"
            class="btn"
            style="background: #6c757d"
          >
            ‚Üê Voltar ao Site
          </a>
        </div>

        <p>
          <small
            >Se voc√™ n√£o for redirecionado automaticamente, clique nos bot√µes
            acima.</small
          >
        </p>
      </div>

      <div id="error" style="display: none">
        <div style="font-size: 40px; color: #dc3545">‚ùå</div>
        <h1>Erro na Confirma√ß√£o</h1>
        <p id="errorMessage"></p>

        <div style="margin: 30px 0">
          <a
            href="https://sarmtech.netlify.app/login/login.html"
            class="btn"
            style="background: #6c757d"
          >
            Tentar Fazer Login
          </a>
          <a href="https://sarm-tech.netlify.app" class="btn">
            Voltar ao Site
          </a>
        </div>
      </div>

      <div id="debug" class="debug-info" style="display: none">
        <h4 style="margin-bottom: 10px">üîç Informa√ß√µes de Debug:</h4>
        <div id="debugContent"></div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
      // ================= CONFIGURA√á√ÉO GLOBAL =================
      const SUPABASE_URL = "https://pjvgzbnqnwrqxwlbndkr.supabase.co";
      const SUPABASE_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBqdmd6Ym5xbndycXh3bGJuZGtyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEyOTU3OTYsImV4cCI6MjA2Njg3MTc5Nn0.tfOu-q0HTCtWTa8wOKWHfgoAl3LBdWULV5O3R2eV4vE";

      // URLs dos sistemas
      const SITE_URL = "https://sarm-tech.netlify.app";
      const SYSTEM_URL = "https://sarmtech.netlify.app";

      // ================= VARI√ÅVEL GLOBAL =================
      let supabaseClient = null;

      // ================= FUN√á√ïES AUXILIARES =================
      function showSection(sectionId) {
        document.getElementById("loading").style.display = "none";
        document.getElementById("success").style.display = "none";
        document.getElementById("error").style.display = "none";
        document.getElementById(sectionId).style.display = "block";
      }

      function showError(message) {
        document.getElementById("errorMessage").textContent = message;
        showSection("error");
      }

      function showSuccess() {
        showSection("success");
        // Redireciona automaticamente ap√≥s 5 segundos
        setTimeout(() => {
          window.location.href = `${SYSTEM_URL}/login.html?confirmed=true`;
        }, 5000);
      }

      function addDebugInfo(text) {
        const debugEl = document.getElementById("debug");
        const contentEl = document.getElementById("debugContent");
        contentEl.innerHTML += `<div>${new Date().toLocaleTimeString()}: ${text}</div>`;
        debugEl.style.display = "block";
      }

      function initializeSupabase() {
        if (!supabaseClient) {
          supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
          addDebugInfo("‚úÖ Supabase inicializado");
        }
        return supabaseClient;
      }

      // ================= L√ìGICA PRINCIPAL =================
      async function processEmailConfirmation() {
        addDebugInfo("üöÄ Iniciando processamento de confirma√ß√£o...");
        addDebugInfo(`üåê URL atual: ${window.location.href}`);

        try {
          // 1. Inicializar Supabase
          addDebugInfo("üîß Inicializando Supabase...");
          const supabase = initializeSupabase();

          // 2. Extrair par√¢metros da URL
          const urlParams = new URLSearchParams(window.location.search);
          const hashParams = new URLSearchParams(
            window.location.hash.substring(1)
          );

          const token = urlParams.get("token") || hashParams.get("token");
          const token_hash =
            urlParams.get("token_hash") || hashParams.get("token_hash");
          const type =
            urlParams.get("type") || hashParams.get("type") || "signup";
          const access_token = hashParams.get("access_token");

          addDebugInfo(
            `üìä Par√¢metros: token=${token ? "SIM" : "N√ÉO"}, token_hash=${
              token_hash ? "SIM" : "N√ÉO"
            }, type=${type}, access_token=${access_token ? "SIM" : "N√ÉO"}`
          );

          // 3. ANALISAR ERRO NA URL (voc√™ est√° recebendo um erro!)
          const error = urlParams.get("error") || hashParams.get("error");
          const error_description =
            urlParams.get("error_description") ||
            hashParams.get("error_description");

          if (error) {
            addDebugInfo(
              `‚ùå ERRO DO SUPABASE: ${error} - ${error_description}`
            );

            // Verificar se √© erro de "already confirmed"
            if (
              error_description &&
              error_description.includes("already confirmed")
            ) {
              addDebugInfo("‚úÖ Email j√° estava confirmado");
              showSuccess();
              return;
            }

            // Para outros erros, tenta continuar
            addDebugInfo("‚ö†Ô∏è Erro na URL, mas tentando continuar...");
          }

          // 4. Se tiver access_token no hash (Magic Link funcionou)
          if (access_token) {
            addDebugInfo("üéØ Magic Link detectado na URL");

            try {
              // Verifica se j√° tem sess√£o
              const { data: sessionData, error: sessionError } =
                await supabase.auth.getSession();

              if (sessionError) {
                addDebugInfo(`‚ùå Erro na sess√£o: ${sessionError.message}`);
                // Tenta usar o access_token diretamente
                const { data: userData, error: userError } =
                  await supabase.auth.getUser(access_token);

                if (userError) throw userError;

                addDebugInfo(
                  `‚úÖ Usu√°rio autenticado via token: ${userData.user.email}`
                );
                showSuccess();
                return;
              }

              if (sessionData.session) {
                addDebugInfo(
                  `‚úÖ Sess√£o ativa: ${sessionData.session.user.email}`
                );
                showSuccess();
                return;
              }
            } catch (hashError) {
              addDebugInfo(
                `‚ö†Ô∏è Erro no processamento do hash: ${hashError.message}`
              );
            }
          }

          // 5. Se tiver token ou token_hash (OTP tradicional)
          if (token || token_hash) {
            addDebugInfo("üîë Processando OTP/Tokens...");

            try {
              // Tenta verificar OTP
              const { data: otpData, error: otpError } =
                await supabase.auth.verifyOtp({
                  token_hash: token_hash || token,
                  type: type,
                });

              if (otpError) {
                addDebugInfo(`‚ùå Erro OTP: ${otpError.message}`);

                // Tenta m√©todo alternativo
                const { data: signInData, error: signInError } =
                  await supabase.auth.signInWithOtp({
                    token: token || token_hash,
                    type: type,
                  });

                if (signInError) throw signInError;

                addDebugInfo("‚úÖ Confirmado via signInWithOtp");
                showSuccess();
                return;
              }

              addDebugInfo("‚úÖ Confirmado via verifyOtp");
              showSuccess();
              return;
            } catch (otpError) {
              addDebugInfo(`‚ùå Falha nos m√©todos OTP: ${otpError.message}`);
            }
          }

          // 6. Se nenhum dos m√©todos acima funcionou, verifica se j√° tem sess√£o
          addDebugInfo("üîç Verificando sess√£o existente...");
          const { data: sessionData, error: sessionError } =
            await supabase.auth.getSession();

          if (sessionError) {
            addDebugInfo(
              `‚ùå Erro na verifica√ß√£o de sess√£o: ${sessionError.message}`
            );
          }

          if (sessionData?.session) {
            addDebugInfo(
              `‚úÖ Sess√£o encontrada: ${sessionData.session.user.email}`
            );

            // Verifica se o email est√° confirmado
            if (sessionData.session.user.email_confirmed_at) {
              addDebugInfo(
                `üìÖ Email confirmado em: ${sessionData.session.user.email_confirmed_at}`
              );
              showSuccess();
              return;
            } else {
              addDebugInfo(
                "‚ö†Ô∏è Email ainda n√£o confirmado no registro da sess√£o"
              );
            }
          }

          // 7. Se chegou aqui, tenta uma √∫ltima verifica√ß√£o
          addDebugInfo("üîÑ Tentando verifica√ß√£o final...");
          const { data: userData, error: userError } =
            await supabase.auth.getUser();

          if (!userError && userData?.user) {
            addDebugInfo(`üë§ Usu√°rio encontrado: ${userData.user.email}`);

            if (userData.user.email_confirmed_at) {
              addDebugInfo(
                `‚úÖ Email j√° estava confirmado: ${userData.user.email_confirmed_at}`
              );
              showSuccess();
              return;
            }
          }

          // 8. Se chegou at√© aqui e n√£o houve erro cr√≠tico, mostra sucesso
          addDebugInfo("‚ÑπÔ∏è Processamento conclu√≠do sem erros cr√≠ticos");
          showSuccess();
        } catch (error) {
          addDebugInfo(`üí• ERRO CR√çTICO: ${error.message}`);
          console.error("Erro completo:", error);

          // Mensagens amig√°veis baseadas no erro
          let userMessage = "N√£o foi poss√≠vel confirmar seu email. ";

          if (error.message.includes("already confirmed")) {
            userMessage = "Seu email j√° foi confirmado anteriormente.";
            showSuccess();
            return;
          } else if (error.message.includes("expired")) {
            userMessage =
              "Este link expirou. Solicite um novo email de confirma√ß√£o.";
          } else if (error.message.includes("Invalid")) {
            userMessage = "Link de confirma√ß√£o inv√°lido ou j√° utilizado.";
          } else if (error.message.includes("server_error")) {
            userMessage =
              "Erro no servidor. O email pode j√° estar confirmado. Tente fazer login.";
          } else {
            userMessage += "Por favor, tente fazer login diretamente.";
          }

          showError(userMessage);
        }
      }

      // ================= INICIALIZA√á√ÉO =================
      document.addEventListener("DOMContentLoaded", () => {
        // Para debugging, pode ativar mostrando par√¢metros
        if (
          window.location.search.includes("debug=true") ||
          window.location.hash.includes("debug=true")
        ) {
          document.getElementById("debug").style.display = "block";
        }

        // Inicializa o Supabase uma vez
        supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Adiciona listener para mudan√ßas de estado
        supabaseClient.auth.onAuthStateChange((event, session) => {
          addDebugInfo(`üîÑ Auth State Change: ${event}`);

          if (event === "SIGNED_IN") {
            addDebugInfo("‚úÖ Usu√°rio acabou de fazer login");
            showSuccess();
          }
        });

        // Inicia o processamento
        processEmailConfirmation();
      });
    </script>
  </body>
</html>
