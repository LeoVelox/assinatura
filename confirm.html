<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Confirma√ß√£o de Email - SarmTech</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <style>
      body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }
      .confirm-card {
        background: white;
        border-radius: 15px;
        padding: 40px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        max-width: 500px;
        width: 100%;
      }
    </style>
  </head>
  <body>
    <div class="confirm-card text-center">
      <div id="loading">
        <div class="spinner-border text-primary mb-3" role="status">
          <span class="visually-hidden">Carregando...</span>
        </div>
        <h3>Confirmando seu email...</h3>
        <p class="text-muted">Aguarde enquanto verificamos sua confirma√ß√£o.</p>
      </div>

      <div id="success" style="display: none">
        <i class="bi bi-check-circle text-success" style="font-size: 4rem"></i>
        <h3 class="mt-3">‚úÖ Email Confirmado!</h3>
        <p>Seu email foi confirmado com sucesso.</p>
        <p>Seu trial de <strong>30 dias</strong> est√° ativo.</p>
        <button
          class="btn btn-primary mt-3"
          onclick="window.location.href='https://sarmtech.netlify.app/login/login.html'"
        >
          <i class="bi bi-box-arrow-in-right me-2"></i>
          Ir para o Login
        </button>
      </div>

      <div id="error" style="display: none">
        <i class="bi bi-x-circle text-danger" style="font-size: 4rem"></i>
        <h3 class="mt-3">‚ùå Erro na Confirma√ß√£o</h3>
        <p id="errorMessage"></p>
        <button
          class="btn btn-outline-primary mt-3"
          onclick="window.location.href='https://sarmtech.netlify.app/login/login.html'"
        >
          Tentar Fazer Login
        </button>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
      // Configura√ß√£o do Supabase
      const supabaseUrl = "https://pjvgzbnqnwrqxwlbndkr.supabase.co";
      const supabaseKey =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBqdmd6Ym5xbndycXh3bGJuZGtyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEyOTU3OTYsImV4cCI6MjA2Njg3MTc5Nn0.tfOu-q0HTCtWTa8wOKWHfgoAl3LBdWULV5O3R2eV4vE";

      const supabase = window.supabase.createClient(supabaseUrl, supabaseKey, {
        auth: {
          flowType: "pkce",
          autoRefreshToken: true,
          persistSession: true,
          detectSessionInUrl: true,
        },
      });

      // Fun√ß√µes para mostrar/ocultar se√ß√µes
      function showSection(sectionId) {
        ["loading", "success", "error"].forEach((id) => {
          document.getElementById(id).style.display =
            id === sectionId ? "block" : "none";
        });
      }

      function showError(message) {
        document.getElementById("errorMessage").textContent = message;
        showSection("error");
      }

      async function processConfirmation() {
        try {
          console.log("üîç Processando confirma√ß√£o de email...");

          // Verificar se h√° hash na URL (PKCE)
          const hash = window.location.hash.substring(1);
          const params = new URLSearchParams(hash);

          if (params.has("access_token") || params.has("error")) {
            // O Supabase processa automaticamente o token na URL com PKCE
            const { data, error } = await supabase.auth.getSession();

            if (error) {
              console.error("Erro na sess√£o:", error);

              // Se o erro for "already confirmed", mostra sucesso
              if (
                error.message &&
                error.message.includes("already confirmed")
              ) {
                showSection("success");
                return;
              }

              throw error;
            }

            if (data.session) {
              console.log("‚úÖ Sess√£o ativa, email confirmado");
              showSection("success");

              // Redireciona ap√≥s 3 segundos
              setTimeout(() => {
                window.location.href =
                  "https://sarmtech.netlify.app/login/login.html";
              }, 3000);
              return;
            }
          }

          // Se chegou aqui e n√£o tem erro, verifica se j√° est√° logado
          const { data: userData } = await supabase.auth.getUser();

          if (userData.user && userData.user.email_confirmed_at) {
            console.log("‚úÖ Usu√°rio j√° confirmado anteriormente");
            showSection("success");

            setTimeout(() => {
              window.location.href =
                "https://sarmtech.netlify.app/login/login.html";
            }, 3000);
            return;
          }

          // Se n√£o conseguiu confirmar mas n√£o h√° erro claro
          showError(
            "N√£o foi poss√≠vel confirmar automaticamente. Tente fazer login."
          );
        } catch (error) {
          console.error("‚ùå Erro no processamento:", error);

          let userMessage = "N√£o foi poss√≠vel confirmar seu email. ";

          if (error.message.includes("already confirmed")) {
            userMessage = "Seu email j√° foi confirmado anteriormente.";
            showSection("success");
            return;
          } else if (error.message.includes("expired")) {
            userMessage =
              "Este link expirou. Solicite um novo email de confirma√ß√£o.";
          } else if (error.message.includes("invalid")) {
            userMessage = "Link de confirma√ß√£o inv√°lido ou j√° utilizado.";
          }

          showError(userMessage);
        }
      }

      // Iniciar processamento quando a p√°gina carregar
      document.addEventListener("DOMContentLoaded", processConfirmation);

      // Timeout de seguran√ßa
      setTimeout(() => {
        if (document.getElementById("loading").style.display !== "none") {
          console.log("‚è±Ô∏è Timeout - mostrando op√ß√£o de login");
          showError(
            "O processamento est√° demorando. Voc√™ pode tentar fazer login diretamente."
          );
        }
      }, 10000);
    </script>
  </body>
</html>
